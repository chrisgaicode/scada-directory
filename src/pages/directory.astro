---
import { getIntegrators } from '../lib/data';

// ‚úÖ CORRECT (for directory.astro)
import Footer from '../components/Footer.astro';

// ‚ùå WRONG (This is what caused the error)
// import Header from '../../components/Header.astro';

const allIntegrators = getIntegrators();

// 1. DATA PREP (Same logic as Homepage to ensure filters match)
const usStateNames = new Set([
  "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida", "Georgia",
  "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland",
  "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey",
  "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina",
  "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming",
  "District of Columbia", "D.C."
]);

const industries = new Set();
const protocols = new Set();
const categories = new Set();
const stateMap = {};

allIntegrators.forEach(i => {
  if (i["Industries Served"]) {
    i["Industries Served"].split(',').forEach(ind => { const clean = ind.trim(); if(clean) industries.add(clean); });
  }
  const pRaw = i["Supported Protocols"] || i["Protocols"];
  if (pRaw) {
    pRaw.split(',').forEach(p => { const clean = p.trim(); if(clean) protocols.add(clean); });
  }
  const cRaw = i["Categories"] || i["Category"];
  if (cRaw) {
    cRaw.split(',').forEach(c => { const clean = c.trim(); if(clean) categories.add(clean); });
  }
  if (i["Location"]) {
    const parts = i["Location"].split(',');
    if (parts.length > 1) {
      const state = parts[parts.length - 1].trim();
      if (usStateNames.has(state)) {
        stateMap[state] = (stateMap[state] || 0) + 1;
      }
    }
  }
});

const uniqueIndustries = Array.from(industries).sort();
const uniqueProtocols = Array.from(protocols).sort();
const uniqueCategories = Array.from(categories).sort();
const states = Object.entries(stateMap).sort((a, b) => a[0].localeCompare(b[0]));
---

<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Search Results - SCADA Directory</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "CollectionPage",
      "name": "SCADA Integrator Directory",
      "description": "Browse verified Industrial Automation and SCADA integration firms.",
      "url": Astro.url.href
    })} />

  </head>
  <body class="bg-slate-950 text-slate-100 font-['Inter'] min-h-screen selection:bg-green-500 selection:text-black">
    
    <header class="border-b border-slate-800 bg-slate-950 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <a href="/" class="flex items-center gap-2 group">
          <div class="h-6 w-6 rounded bg-green-500/10 border border-green-500/50 flex items-center justify-center text-green-500">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5"></path></svg>
          </div>
          <span class="font-bold text-md tracking-tight text-white">SCADA<span class="text-green-400">Directory</span></span>
        </a>
        <div class="flex items-center gap-6">
      <a href="/#match-form" class="px-4 py-2 rounded-full bg-green-500 text-slate-950 font-bold hover:bg-green-400 transition-all shadow-[0_0_15px_rgba(34,197,94,0.3)] whitespace-nowrap text-xs">
        Get Matched
      </a>
      <a href="/" class="text-xs font-bold text-slate-500 hover:text-white transition-colors">
        &larr; Back Home
      </a>
    </div>
      </div>

      <div class="border-t border-slate-800 bg-slate-900/50 backdrop-blur">
        <div class="max-w-7xl mx-auto px-4 py-3">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
            
            <select id="industrySelect" class="bg-slate-950 border border-slate-700 text-slate-300 text-xs rounded-md p-2 focus:border-green-500 outline-none">
              <option value="">All Industries</option>
              {uniqueIndustries.map(i => <option value={i}>{i}</option>)}
            </select>

            <select id="categorySelect" class="bg-slate-950 border border-slate-700 text-slate-300 text-xs rounded-md p-2 focus:border-green-500 outline-none">
              <option value="">All Systems</option>
              {uniqueCategories.map(c => <option value={c}>{c}</option>)}
            </select>

            <select id="protocolSelect" class="bg-slate-950 border border-slate-700 text-slate-300 text-xs rounded-md p-2 focus:border-green-500 outline-none">
              <option value="">All Protocols</option>
              {uniqueProtocols.map(p => <option value={p}>{p}</option>)}
            </select>

            <select id="stateSelect" class="bg-slate-950 border border-slate-700 text-slate-300 text-xs rounded-md p-2 focus:border-green-500 outline-none">
              <option value="">All Locations</option>
              {states.map(([s]) => <option value={s}>{s}</option>)}
            </select>

          </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
      
      <div class="flex justify-between items-end mb-6">
        <h1 class="text-xl font-bold text-white">Search Results</h1>
        <div class="text-sm text-slate-500">
          Found <span id="countDisplay" class="text-green-400 font-mono font-bold">0</span> matches
        </div>
      </div>

      <div id="integratorGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>

      <div id="noResults" class="hidden py-20 text-center border border-dashed border-slate-800 rounded-xl bg-slate-900/50">
        <p class="text-slate-400 text-lg mb-2">No integrators found matching these filters.</p>
        <button id="clearFilters" class="text-green-400 font-bold hover:underline text-sm">Clear Filters & Show All</button>
      </div>

    </main>

    <script define:vars={{ allIntegrators }}>
      const integrators = allIntegrators;
      
      const grid = document.getElementById('integratorGrid');
      const countDisplay = document.getElementById('countDisplay');
      const noResults = document.getElementById('noResults');
      
      const industrySelect = document.getElementById('industrySelect');
      const categorySelect = document.getElementById('categorySelect');
      const protocolSelect = document.getElementById('protocolSelect');
      const stateSelect = document.getElementById('stateSelect');
      const clearBtn = document.getElementById('clearFilters');

      // 1. Render Function
      function renderGrid(items) {
        grid.innerHTML = '';
        countDisplay.textContent = items.length;
        
        if (items.length === 0) {
          noResults.classList.remove('hidden');
          grid.classList.add('hidden');
          return;
        }
        
        noResults.classList.add('hidden');
        grid.classList.remove('hidden');

        // Render Cards (Consistent Dark Mode Style)
        items.forEach(integrator => {
          const name = integrator.name || integrator["Integrator Name"];
          const loc = integrator.location || integrator["Location"];
          const cert = integrator["Certification Level"] || "";
          
          const rawSlug = integrator.slug || integrator["Slug"] || name;
          const safeSlug = rawSlug.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '');

          const isPremier = cert && cert.includes("Premier");
          const industries = (integrator["Industries Served"] || "").split(',').slice(0, 3);

          const card = document.createElement('a');
          card.href = `/integrator/${safeSlug}`;
          card.className = "block bg-slate-900 border border-slate-800 rounded-xl p-6 hover:border-green-500/50 hover:bg-slate-800 transition-all group h-full flex flex-col";
          
          card.innerHTML = `
            <div class="flex justify-between items-start mb-4">
              <h3 class="font-bold text-white group-hover:text-green-400 transition-colors text-lg">${name}</h3>
              ${isPremier ? '<span class="bg-amber-500/10 text-amber-500 text-[10px] font-bold px-2 py-1 rounded border border-amber-500/20 uppercase">Premier</span>' : ''}
            </div>
            
            <p class="text-sm text-slate-500 mb-6 flex items-center gap-1">üìç ${loc}</p>
            
            <div class="mt-auto flex flex-wrap gap-2">
              ${industries.map(tag => {
                const t = tag.trim();
                return t ? `<span class="text-[10px] bg-slate-950 text-slate-400 border border-slate-700 px-2 py-1 rounded">${t}</span>` : '';
              }).join('')}
            </div>
          `;
          grid.appendChild(card);
        });
      }

      // 2. Filter Function
      function filterIntegrators() {
        const sIndustry = industrySelect.value;
        const sCategory = categorySelect.value;
        const sProtocol = protocolSelect.value;
        const sState = stateSelect.value;

        const filtered = integrators.filter(item => {
          const iInd = item["Industries Served"] || "";
          const iLoc = item["Location"] || "";
          const iCat = item["Categories"] || item["Category"] || "";
          const iProt = item["Supported Protocols"] || item["Protocols"] || "";

          const matchInd = sIndustry === "" || iInd.includes(sIndustry);
          const matchLoc = sState === "" || iLoc.includes(sState);
          const matchCat = sCategory === "" || iCat.includes(sCategory);
          const matchProt = sProtocol === "" || iProt.includes(sProtocol);

          return matchInd && matchLoc && matchCat && matchProt;
        });

        renderGrid(filtered);
      }

      // 3. Initialize from URL Params
      function init() {
        const params = new URLSearchParams(window.location.search);
        
        if(params.has('industry')) industrySelect.value = params.get('industry');
        if(params.has('system')) categorySelect.value = params.get('system');
        if(params.has('protocol')) protocolSelect.value = params.get('protocol');
        if(params.has('location')) stateSelect.value = params.get('location');

        filterIntegrators();
      }

      // Listeners
      industrySelect.addEventListener('change', filterIntegrators);
      categorySelect.addEventListener('change', filterIntegrators);
      protocolSelect.addEventListener('change', filterIntegrators);
      stateSelect.addEventListener('change', filterIntegrators);
      
      clearBtn.addEventListener('click', () => {
        industrySelect.value = "";
        categorySelect.value = "";
        protocolSelect.value = "";
        stateSelect.value = "";
        filterIntegrators();
        // Clear URL params without refresh
        window.history.pushState({}, '', window.location.pathname);
      });

      // Run
      init();
    </script>
    <Footer />
  </body>
</html>