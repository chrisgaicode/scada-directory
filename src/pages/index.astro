---
import { getIntegrators } from '../lib/data';

import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

const allIntegrators = getIntegrators();

// 1. DATA PROCESSING
const usStateNames = new Set([
  "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida", "Georgia",
  "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland",
  "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey",
  "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina",
  "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming",
  "District of Columbia", "D.C."
]);

const industries = new Set();
const protocols = new Set();
const categories = new Set();
const stateMap = {};

allIntegrators.forEach(i => {
  if (i["Industries Served"]) {
    i["Industries Served"].split(',').forEach(ind => { const clean = ind.trim(); if(clean) industries.add(clean); });
  }
  const pRaw = i["Supported Protocols"] || i["Protocols"];
  if (pRaw) {
    pRaw.split(',').forEach(p => { const clean = p.trim(); if(clean) protocols.add(clean); });
  }
  const cRaw = i["Categories"] || i["Category"];
  if (cRaw) {
    cRaw.split(',').forEach(c => { const clean = c.trim(); if(clean) categories.add(clean); });
  }
  if (i["Location"]) {
    const parts = i["Location"].split(',');
    if (parts.length > 1) {
      const state = parts[parts.length - 1].trim();
      if (usStateNames.has(state)) {
        stateMap[state] = (stateMap[state] || 0) + 1;
      }
    }
  }
});

const uniqueIndustries = Array.from(industries).sort();
const uniqueProtocols = Array.from(protocols).sort();
const uniqueCategories = Array.from(categories).sort();
const states = Object.entries(stateMap).sort((a, b) => a[0].localeCompare(b[0]));

// Featured Logic
const featuredIntegrators = allIntegrators
  .filter(i => (i["Certification Level"] || "").includes("Premier"))
  .slice(0, 6);
---

<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Ignition & SCADA Integrator Directory</title>
    <meta name="description" content="Find verified Ignition Premier Integrators and SCADA engineering firms. Search by industry, protocol (MQTT, Sparkplug), and location." />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "SCADA Directory",
      "url": Astro.site ? Astro.site : "https://scadadirectory.com",
      "description": "Connect with verified SCADA integrators, PLC programmers, and automation engineering firms.",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://scadadirectory.com/directory?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    })} />
  
  </head>
  <body class="bg-slate-950 text-slate-100 font-['Inter'] min-h-screen selection:bg-green-500 selection:text-black">
    
<Header />

    <main>
      
      <section class="max-w-7xl mx-auto px-4 py-12 md:py-20 lg:py-24 grid lg:grid-cols-2 gap-16 items-start">
        
        <div class="space-y-8">
          <div class="space-y-4">
            <span class="text-green-400 font-bold tracking-wider text-xs uppercase bg-green-400/10 px-3 py-1 rounded-full border border-green-400/20">The Industrial Network</span>
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-white leading-tight">
              Find Verified <br/>
              <span class="text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-600">SCADA Integrators</span>
            </h1>
            <p class="text-lg text-slate-400 leading-relaxed max-w-xl">
              Connect with engineering firms who understand MQTT, Ignition, and modern industrial protocols. Search the directory or let us match you.
            </p>
          </div>

          <div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl shadow-xl">
            <h3 class="text-white font-semibold mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
              Search the Directory
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="space-y-1">
                <label class="text-xs font-medium text-slate-500 uppercase">Industry</label>
                <select id="industrySelect" class="w-full bg-slate-950 border border-slate-700 text-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none text-sm">
                  <option value="">All Industries</option>
                  {uniqueIndustries.map(i => <option value={i}>{i}</option>)}
                </select>
              </div>
              <div class="space-y-1">
                <label class="text-xs font-medium text-slate-500 uppercase">System</label>
                <select id="categorySelect" class="w-full bg-slate-950 border border-slate-700 text-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none text-sm">
                  <option value="">All Systems</option>
                  {uniqueCategories.map(c => <option value={c}>{c}</option>)}
                </select>
              </div>
              <div class="space-y-1">
                <label class="text-xs font-medium text-slate-500 uppercase">Protocol</label>
                <select id="protocolSelect" class="w-full bg-slate-950 border border-slate-700 text-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none text-sm">
                  <option value="">All Protocols</option>
                  {uniqueProtocols.map(p => <option value={p}>{p}</option>)}
                </select>
              </div>
              <div class="space-y-1">
                <label class="text-xs font-medium text-slate-500 uppercase">Location</label>
                <select id="stateSelect" class="w-full bg-slate-950 border border-slate-700 text-slate-200 rounded-lg p-2.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none text-sm">
                  <option value="">All US Locations</option>
                  {states.map(([s]) => <option value={s}>{s}</option>)}
                </select>
              </div>
            </div>
            <button id="searchBtn" class="mt-4 w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors border border-slate-700">
              Browse Directory Matches
            </button>
          </div>
        </div>

        <div class="relative group">
          <div class="absolute -inset-1 bg-gradient-to-r from-green-600 to-emerald-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
          <div id="match-form" class="relative bg-slate-900 border border-slate-800 rounded-xl p-6 md:p-8 shadow-2xl scroll-mt-32">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-bold text-white">Start your Project Brief</h3>
            </div>
            
            <form id="leadCaptureForm" class="space-y-5">
              
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Company Name <span class="text-red-500">*</span></label>
                <input 
                  type="text" 
                  id="companyName" 
                  name="companyName" 
                  placeholder="Your Company Name" 
                  required
                  class="w-full bg-slate-950 border border-slate-800 text-slate-300 text-sm rounded-lg p-3 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none placeholder-slate-600" 
                />
                <span id="companyNameError" class="text-red-500 text-xs mt-1 hidden">Company name is required</span>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Work Email <span class="text-red-500">*</span></label>
                <input 
                  type="email" 
                  id="workEmail" 
                  name="workEmail" 
                  placeholder="name@company.com" 
                  required
                  class="w-full bg-slate-950 border border-slate-800 text-slate-300 text-sm rounded-lg p-3 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none placeholder-slate-600" 
                />
                <span id="workEmailError" class="text-red-500 text-xs mt-1 hidden">Valid work email is required</span>
              </div>
              
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Project Scope <span class="text-red-500">*</span></label>
                <div id="scopeContainer" class="flex flex-wrap gap-2">
                  <button type="button" class="scope-badge px-3 py-1 bg-slate-800 text-slate-400 border border-slate-700 text-xs rounded-full cursor-pointer hover:border-slate-500 transition-all text-left" data-value="New SCADA System">New SCADA System</button>
                  <button type="button" class="scope-badge px-3 py-1 bg-slate-800 text-slate-400 border border-slate-700 text-xs rounded-full cursor-pointer hover:border-slate-500 transition-all text-left" data-value="Migration / Upgrade">Migration / Upgrade</button>
                  <button type="button" class="scope-badge px-3 py-1 bg-slate-800 text-slate-400 border border-slate-700 text-xs rounded-full cursor-pointer hover:border-slate-500 transition-all text-left" data-value="PLC Programming">PLC Programming</button>
                  <button type="button" class="scope-badge px-3 py-1 bg-slate-800 text-slate-400 border border-slate-700 text-xs rounded-full cursor-pointer hover:border-slate-500 transition-all text-left" data-value="MES / OEE">MES / OEE</button>
                  <button type="button" class="scope-badge px-3 py-1 bg-slate-800 text-slate-400 border border-slate-700 text-xs rounded-full cursor-pointer hover:border-slate-500 transition-all text-left" data-value="Other / Consulting">Other / Consulting</button>
                </div>
                <span id="projectScopeError" class="text-red-500 text-xs mt-1 hidden">Please select at least one project scope</span>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Project Details</label>
                <textarea 
                  id="projectDetails" 
                  name="projectDetails" 
                  class="w-full bg-slate-950 border border-slate-800 text-slate-300 text-sm rounded-lg p-3 h-24 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none resize-none placeholder-slate-600" 
                  placeholder="Briefly describe your current system (e.g. Rockwell PLCs, Ignition 8.1) and what you need to achieve..."
                ></textarea>
              </div>

              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Website (Optional)</label>
                <input 
                  type="text" 
                  id="website" 
                  name="website" 
                  placeholder="https://yourcompany.com" 
                  class="w-full bg-slate-950 border border-slate-800 text-slate-300 text-sm rounded-lg p-3 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none placeholder-slate-600" 
                />
              </div>

              <div id="formMessage" class="hidden p-3 rounded-lg text-sm"></div>

              <button 
                type="submit" 
                id="submitBtn"
                class="w-full bg-green-500 hover:bg-green-400 text-slate-950 font-bold py-3 px-4 rounded-lg transition-all transform active:scale-95 shadow-[0_0_20px_rgba(34,197,94,0.3)] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
              >
                <span id="submitBtnText">Find Matching Integrators</span>
                <span id="submitBtnLoading" class="hidden">
                  <svg class="animate-spin inline-block w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Submitting...
                </span>
              </button>
            </form>
          </div>
        </div>
      </section>

<section id="how-it-works" class="bg-slate-900 border-t border-slate-800 py-20">
        <div class="max-w-7xl mx-auto px-4">
          
          <div class="mb-12">
            <h2 class="text-3xl font-extrabold text-white">
              How It <span class="text-green-400">Works</span>
            </h2>
            <p class="text-slate-400 mt-4 text-lg leading-relaxed">
              We connect you with verified engineering firms that match your specific platform needs and industry requirements.
            </p>
          </div>

          <div class="grid md:grid-cols-3 gap-12">
            
            <div class="space-y-4">
              <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="text-green-400">01.</span> Modern Architectures
              </h3>
              <p class="text-slate-400 leading-relaxed text-sm">
                Industrial automation is shifting from legacy HMI to <strong class="text-slate-200">IIoT-enabled architectures</strong>. 
                The integrators listed here specialize in modern standards like <strong class="text-slate-200">MQTT Sparkplug B</strong>, 
                Edge Computing, and Cloud connectivity.
              </p>
            </div>

            <div class="space-y-4">
              <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="text-green-400">02.</span> Verified Expertise
              </h3>
              <p class="text-slate-400 leading-relaxed text-sm">
                We index certifications including <strong class="text-slate-200">Ignition Premier Integrator</strong> status 
                and <strong class="text-slate-200">CSIA Certification</strong> to ensure you are connecting with 
                firms that have proven engineering discipline and financial stability.
              </p>
            </div>

            <div class="space-y-4">
              <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="text-green-400">03.</span> Industry Specificity
              </h3>
              <p class="text-slate-400 leading-relaxed text-sm">
                A Water/Wastewater expert may not know FDA validation for Pharma. 
                Our directory uses <strong class="text-slate-200">Entity-Based Filtering</strong> to match you based on 
                vertical expertise‚Äîwhether that's OEE for manufacturing or Telemetry for Oil & Gas.
              </p>
            </div>

          </div>
        </div>
      </section>

      <section class="max-w-7xl mx-auto px-4 py-20">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-2xl font-bold text-white">Featured Premier Integrators</h2>
          <a href="#" class="text-sm text-green-400 font-bold hover:underline">Find More Integrators &rarr;</a>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {featuredIntegrators.map(integrator => {
            const name = integrator.name || integrator["Integrator Name"];
            const loc = integrator.location || integrator["Location"];
            const rawSlug = integrator.slug || integrator["Slug"] || name;
            const safeSlug = rawSlug.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '');
            const industries = (integrator["Industries Served"] || "").split(',').slice(0, 3);

            return (
              <a href={`/integrator/${safeSlug}`} class="block bg-slate-900 border border-slate-800 rounded-xl p-6 hover:border-green-500/50 hover:bg-slate-800 transition-all group">
                <div class="flex justify-between items-start mb-4">
                  <h3 class="font-bold text-white group-hover:text-green-400 transition-colors">{name}</h3>
                  <span class="bg-amber-500/10 text-amber-500 text-[10px] font-bold px-2 py-1 rounded border border-amber-500/20 uppercase">Premier</span>
                </div>
                <p class="text-sm text-slate-500 mb-6">üìç {loc}</p>
                <div class="flex flex-wrap gap-2">
                  {industries.map(tag => (
                    <span class="text-[10px] bg-slate-950 text-slate-400 border border-slate-700 px-2 py-1 rounded">{tag.trim()}</span>
                  ))}
                </div>
              </a>
            )
          })}
        </div>
      </section>

    </main>

<script>
      // ===== DIRECTORY SEARCH FUNCTIONALITY =====
      const btn = document.getElementById('searchBtn');
      const ind = document.getElementById('industrySelect');
      const sys = document.getElementById('categorySelect');
      const proto = document.getElementById('protocolSelect');
      const loc = document.getElementById('stateSelect');

      if(btn) {
        btn.addEventListener('click', () => {
          // Build Query Params
          const params = new URLSearchParams();
          if(ind.value) params.append('industry', ind.value);
          if(sys.value) params.append('system', sys.value);
          if(proto.value) params.append('protocol', proto.value);
          if(loc.value) params.append('location', loc.value);

          // Redirect to Directory Page
          window.location.href = `/directory?${params.toString()}`;
        });
      }
      
      // ===== PROJECT SCOPE SELECTION LOGIC =====
      const badges = document.querySelectorAll('.scope-badge');
      badges.forEach(badge => {
        badge.addEventListener('click', () => {
          // Check if currently selected by looking for the selected state
          const isSelected = badge.classList.contains('bg-green-500/10');
          
          if (isSelected) {
            // Deselect - restore default state
            badge.classList.remove('bg-green-500/10', 'text-green-400', 'border-green-500');
            badge.classList.add('bg-slate-800', 'text-slate-400', 'border-slate-700');
          } else {
            // Select - apply selected state
            badge.classList.remove('bg-slate-800', 'text-slate-400', 'border-slate-700');
            badge.classList.add('bg-green-500/10', 'text-green-400', 'border-green-500');
          }
        });
      });

      // ===== LEAD CAPTURE FORM =====
      const form = document.getElementById('leadCaptureForm');
      const submitBtn = document.getElementById('submitBtn');
      const submitBtnText = document.getElementById('submitBtnText');
      const submitBtnLoading = document.getElementById('submitBtnLoading');
      const formMessage = document.getElementById('formMessage');

      // Helper function to show error message
      function showError(elementId, show = true) {
        const errorElement = document.getElementById(elementId);
        if (errorElement) {
          if (show) {
            errorElement.classList.remove('hidden');
          } else {
            errorElement.classList.add('hidden');
          }
        }
      }

      // Helper function to show form message
      function showFormMessage(message, isSuccess = true) {
        formMessage.textContent = message;
        formMessage.classList.remove('hidden', 'bg-green-500/10', 'text-green-400', 'border', 'border-green-500/20', 'bg-red-500/10', 'text-red-400', 'border-red-500/20');
        
        if (isSuccess) {
          formMessage.classList.add('bg-green-500/10', 'text-green-400', 'border', 'border-green-500/20');
        } else {
          formMessage.classList.add('bg-red-500/10', 'text-red-400', 'border', 'border-red-500/20');
        }
      }

      // Helper function to hide form message
      function hideFormMessage() {
        formMessage.classList.add('hidden');
      }

      // Email validation function
      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // Validate form
      function validateForm() {
        let isValid = true;
        hideFormMessage();

        // Clear all previous errors
        showError('companyNameError', false);
        showError('workEmailError', false);
        showError('projectScopeError', false);

        // Validate Company Name
        const companyName = document.getElementById('companyName').value.trim();
        if (!companyName) {
          showError('companyNameError', true);
          isValid = false;
        }

        // Validate Work Email
        const workEmail = document.getElementById('workEmail').value.trim();
        if (!workEmail || !isValidEmail(workEmail)) {
          showError('workEmailError', true);
          isValid = false;
        }

        // Validate Project Scope (at least one must be selected)
        const selectedScopes = document.querySelectorAll('.scope-badge.bg-green-500\\/10');
        if (selectedScopes.length === 0) {
          showError('projectScopeError', true);
          isValid = false;
        }

        return isValid;
      }

      // Collect selected project scopes
      function getSelectedProjectScopes() {
        const selectedScopes = document.querySelectorAll('.scope-badge.bg-green-500\\/10');
        return Array.from(selectedScopes).map(badge => badge.getAttribute('data-value'));
      }

      // Handle form submission
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          // Validate form
          if (!validateForm()) {
            showFormMessage('Please fill in all required fields correctly.', false);
            return;
          }

          // Disable submit button and show loading state
          submitBtn.disabled = true;
          submitBtnText.classList.add('hidden');
          submitBtnLoading.classList.remove('hidden');

          // Collect form data
          const formData = {
            companyName: document.getElementById('companyName').value.trim(),
            workEmail: document.getElementById('workEmail').value.trim(),
            projectScope: getSelectedProjectScopes(),
            projectDetails: document.getElementById('projectDetails').value.trim() || '',
            website: document.getElementById('website').value.trim() || ''
          };

          try {
            // Submit to n8n webhook
            const response = await fetch('https://aios.webstreamsolutions.com/webhook/scada-directory-lead-intake', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(formData)
            });

            if (response.ok) {
              // Success - show success message
              showFormMessage('‚úì Thank you! We\'ll be in touch soon with matching integrators.', true);
              
              // Reset form
              form.reset();
              
              // Clear all scope badge selections
              const allBadges = document.querySelectorAll('.scope-badge');
              allBadges.forEach(badge => {
                badge.classList.remove('bg-green-500/10', 'text-green-400', 'border-green-500');
                badge.classList.add('bg-slate-800', 'text-slate-400', 'border-slate-700');
              });

              // Scroll to message
              formMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
              // Error response from server
              throw new Error('Server responded with an error');
            }
          } catch (error) {
            // Network or other error
            console.error('Form submission error:', error);
            showFormMessage('‚ö† Something went wrong. Please try again or contact us directly.', false);
          } finally {
            // Re-enable submit button and restore normal state
            submitBtn.disabled = false;
            submitBtnText.classList.remove('hidden');
            submitBtnLoading.classList.add('hidden');
          }
        });
      }
    </script>
    <Footer />
  </body>
</html>